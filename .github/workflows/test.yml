name: Test

on:
  push: &trigger_config
    branches: [main]
    paths:
      - 'kkhys/scripts/**'
      - 'kkhys/tests/**'
      - '.github/workflows/test.yml'
  pull_request: *trigger_config
  workflow_dispatch:

jobs:
  test:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Cache bats-core
        id: cache-bats
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ~/.local
          key: ${{ runner.os }}-bats-core-1.11.0
          restore-keys: |
            ${{ runner.os }}-bats-core-

      - name: Install bats-core (Linux)
        if: runner.os == 'Linux' && steps.cache-bats.outputs.cache-hit != 'true'
        run: |
          git clone --depth 1 --branch v1.11.0 https://github.com/bats-core/bats-core.git
          cd bats-core
          ./install.sh ~/.local
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install bats-core (macOS)
        if: runner.os == 'macOS'
        run: brew install bats-core

      - name: Verify bats-core installation
        run: |
          which bats
          bats --version

      - name: Make scripts executable
        run: chmod +x kkhys/scripts/*.sh

      - name: Run tests
        run: bats kkhys/tests/create-memo.bats

      - name: Test summary
        if: always()
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- OS: ${{ matrix.os }}" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
